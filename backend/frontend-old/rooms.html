<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Rooms</title>
    <script src="../socket.io/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 30px auto; padding: 20px; }
        h1 { text-align: center; }
        #roomList { list-style-type: none; padding: 0; }
        #roomList li { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { cursor: pointer; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #333;
            padding: 10px 0;
            z-index: 1000;
            text-align: right;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 10px;
            margin: 0 5px;
        }

        nav a:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <nav>
        <a href="/rooms.html">Game Rooms</a>
        <a href="/index.html">Sign Up</a>
        <button id="loginWithTestUser">Login with Test User</button>
        <button id="logout">Logout</button>
        <a id="userInfo">Logged in as: </a>
    </nav>
    <h1>Game Rooms</h1>
    <button id="createRoom">Create New Room</button>
    <ul id="roomList"></ul>

    <script>
        const socket = io();
        const roomList = document.getElementById('roomList');
        const createRoomButton = document.getElementById('createRoom');
        const logoutButton = document.getElementById('logout');
        let userId;
        let accessToken = localStorage.getItem('accessToken')

        document.getElementById('loginWithTestUser').onclick = () => {
            loginWithTestUser();
        }

        function loginWithTestUser() {
            login('dennistowns9@gmail.com', 'Password1');
        }

        logoutButton.onclick = () => {
            logoutUser();
        }

        function logoutUser() {
            fetch('/api/users/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
            })
            .then(response => response.json())
            .then(data => {
                console.log('logoutUser data:', data);
                if (data.success) {
                    console.log('User logged out successfully');
                    window.location.href = '/index.html';
                } else {
                    console.error('Error logging out user:', data.message);
                }
            })
            .catch(error => console.error('Error logging out user:', error));
        }

        function fetchRooms() {
            fetch('/api/games/get-rooms/', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
                .then(response => response.json())
                .then(response => {
                    console.log('fetchRooms response:', response);
                    if (response.success && response.rooms.length > 0) {
                        roomList.innerHTML = '';
                        response.rooms.forEach(room => {
                            const li = document.createElement('li');
                            li.textContent = `Room ${room.id} - Players: ${room.players ? room.players.length : 0}`;
                            const joinButton = document.createElement('button');
                            joinButton.textContent = 'Join';
                            joinButton.onclick = () => joinRoom(room.id);
                            li.appendChild(joinButton);
                            roomList.appendChild(li);
                        });
                    }
                })
                .catch(error => console.error('Error fetching rooms:', error));
        }

        function validateSession() {
            fetch('/api/users/get-session', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
            })
            .then(response => response.json())
            .then(data => {
                console.log('validateSession data:', data);
                if (data.success && data.session) {
                    console.log('Session:', data);
                    userId = data.session.user.email;
                    accessToken = data.session.access_token;
                    document.getElementById('userInfo').textContent = `Logged in as: ${data.session.user.email}`;
                } else {
                   console.log('Session not valid');
                   window.location.href = '/';
                }
            })
            .catch(error => {
                console.error('Error validating session:', error);
                window.location.href = '/';
            });
        }

        validateSession();

        setInterval(validateSession, 15000);

        createRoomButton.onclick = () => {
            fetch('/api/games/create-room', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({ userId: userId || null })
            })
            .then(response => response.json())
            .then(room => {
                console.log('New room created:', room);
                joinRoom(room.roomId); 
            })
            .catch(error => console.error('Error creating room:', error));
        };

        function joinRoom(roomId) {
            console.log("join room called with roomId:", roomId);
            socket.emit('join-room', roomId, userId, (response) => {
                console.log("join-room response:", response);
                if (response.success) {
                    console.log(`Joined room ${roomId}`);
                    alert(`You've joined room ${roomId}`);
                    window.location.href = `/lobby/${roomId}`;
                } else {
                    console.error('Failed to join room:', response.error);
                    alert('Failed to join room: ' + response.error);
                }
            });
        }

        fetchRooms();

        socket.on('rooms updated', fetchRooms);
    </script>
</body>
</html>
